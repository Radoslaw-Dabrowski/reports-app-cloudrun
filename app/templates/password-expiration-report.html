{% extends "base-template.html" %}

{% block title %}Password Expiration{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="text-center my-4">Password Expiration</h1>

    <!-- Color Legend -->
    <div class="color-legend mb-4">
        <span class="legend-item" style="background-color: white;">White - More than 20 days or Never</span>
        <span class="legend-item" style="background-color: yellow;">Yellow - 11 to 20 days</span>
        <span class="legend-item" style="background-color: orange;">Orange - 5 to 10 days</span>
        <span class="legend-item" style="background-color: red; color: white;">Red - 0 to 4 days</span>
        <span class="legend-item" style="background-color: black; color: white;">Black - Past expiration</span>
    </div>

    <!-- Form for Filters and Actions -->
    <div class="form-container mb-4">
        <!-- Filter Options -->
        <ul class="ks-cboxtags">
            <li>
                <input type="checkbox" id="filterCritical">
                <label for="filterCritical">Critical Entries</label>
            </li>
            <li>
                <input type="checkbox" id="filterRotationNeeded" checked>
                <label for="filterRotationNeeded">Rotation Needed</label>
            </li>
            <li>
                <input type="checkbox" id="filterFailed">
                <label for="filterFailed">Failed Only</label>
            </li>
        </ul>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="toggleLocationsButton" class="btn btn-outline-secondary">Toggle Locations</button>
            <button id="exportButton" class="btn btn-primary">Export to CSV</button>
        </div>
    </div>

    <!-- Floating checkbox list for locations -->
    <div id="locationCheckboxList" class="floating-checkbox-list" style="display: none;">
        <div class="check-group">
            {% set locations = [] %}
            {% for row in table_data %}
                {% if row.Location not in locations %}
                    {% set _ = locations.append(row.Location) %}
                {% endif %}
            {% endfor %}
            {% for location in locations|sort %}
            <label for="locationCheckbox{{ loop.index }}" class="checkbox">
                <input class="checkbox__input" type="checkbox" id="locationCheckbox{{ loop.index }}" data-location="{{ location }}" checked>
                <svg class="checkbox__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22">
                    <rect width="21" height="21" x=".5" y=".5" fill="#FFF" stroke="#006F94" rx="3" />
                    <path class="tick" stroke="#6EA340" fill="none" stroke-linecap="round" stroke-width="4" d="M4 10l5 5 9-9" />
                </svg>
                <span class="checkbox__label">{{ location }}</span>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="password-expiration-table-container table-container">
        <div id="reportTable"></div> <!-- Tabulator will render here -->
    </div>
</div>

<script>
    $(document).ready(function() {
        // Sample data (replace with your actual data)
        var tableData = [
            {% for row in table_data %}
            {
                customer: "{{ row.Customer }}",
                location: "{{ row.Location }}",
                reportDate: "{{ row['Report Date'] }}",
                hostName: "{{ row['Host name'] }}",
                username: "{{ row['Username'] }}",
                lastPasswordRotation: "{{ row['Last password rotation'] }}",
                customerAgreedRotation: "{{ row['Customer agreed rotation'] }}",
                passwordExpirationDate: "{{ row['Password expiration date'] }}",
                rotationNeeded: "{{ row['Rotation needed'] }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Function to set a cookie
        function setCookie(name, value, days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        // Function to get a cookie
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Toggle Locations
        $('#toggleLocationsButton').click(function() {
            $('#locationCheckboxList').toggle();
            setCookie('locationCheckboxListVisible', $('#locationCheckboxList').is(':visible'), 7);
        });

        // Function to get checked locations
        function getCheckedLocations() {
            var checkedLocations = [];
            $('#locationCheckboxList input:checked').each(function() {
                checkedLocations.push($(this).data('location'));
            });
            return checkedLocations;
        }

        // Save the state of location checkboxes
        function saveLocationCheckboxState() {
            $('#locationCheckboxList input').each(function() {
                var location = $(this).data('location');
                setCookie('locationCheckbox_' + location, $(this).is(':checked'), 7);
            });
        }

        // Restore the state of location checkboxes
        function restoreLocationCheckboxState() {
            $('#locationCheckboxList input').each(function() {
                var location = $(this).data('location');
                var checked = getCookie('locationCheckbox_' + location) === 'true';
                $(this).prop('checked', checked);
            });
        }

        // Initialize Tabulator
        var table = new Tabulator("#reportTable", {
            data: tableData,
            layout: "fitColumns", // Fit columns to width of table
            columns: [
                {title: "Customer", field: "customer", headerFilter: "input"},
                {title: "Location", field: "location", headerFilter: "input"},
                {title: "Report Date", field: "reportDate", headerFilter: "input"},
                {title: "Host Name", field: "hostName", headerFilter: "input"},
                {title: "Username", field: "username", headerFilter: "input"},
                {title: "Last Password Rotation", field: "lastPasswordRotation", headerFilter: "input"},
                {title: "Customer Agreed Rotation", field: "customerAgreedRotation", headerFilter: "input"},
                {title: "Password Expiration Date", field: "passwordExpirationDate", headerFilter: "input", sorter: customDateSorter, sorterParams: {format: "YYYY-MM-DD"}, sortOrder: "desc"},
                {title: "Rotation Needed", field: "rotationNeeded", headerFilter: "input"},
            ],
            pagination: "local",
            paginationSize: 100,
            rowFormatter: function(row) {
                var data = row.getData();
                var expirationDate = new Date(data.passwordExpirationDate);
                var today = new Date();
                var timeDiff = expirationDate - today;
                var daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                if (daysDiff > 20 || isNaN(daysDiff)) {
                    row.getElement().style.backgroundColor = "white";
                } else if (daysDiff >= 11 && daysDiff <= 20) {
                    row.getElement().style.backgroundColor = "yellow";
                } else if (daysDiff >= 5 && daysDiff <= 10) {
                    row.getElement().style.backgroundColor = "orange";
                } else if (daysDiff >= 0 && daysDiff <= 4) {
                    row.getElement().style.backgroundColor = "red";
                } else if (daysDiff < 0) {
                    row.getElement().style.backgroundColor = "black";
                    row.getElement().style.color = "white";
                }
            }
        });

        // Custom sorter for handling special cases in date sorting
        function customDateSorter(a, b, aRow, bRow, column, dir, sorterParams) {
            const specialCases = {"Never": Infinity, "never": Infinity, "Failed": Infinity, "Unknown": Infinity, "unknown": Infinity};

            const aValue = specialCases[a] !== undefined ? specialCases[a] : new Date(a);
            const bValue = specialCases[b] !== undefined ? specialCases[b] : new Date(b);

            if (aValue < bValue) {
                return -1;
            } else if (aValue > bValue) {
                return 1;
            } else {
                return 0;
            }
        }

        // Function to apply filters
        function applyFilters() {
            var filters = [];

            // Filter by checked locations
            var checkedLocations = getCheckedLocations();
            if (checkedLocations.length > 0) {
                filters.push({field: "location", type: "in", value: checkedLocations});
            }

            // Filter by critical entries
            if ($('#filterCritical').is(':checked')) {
                filters.push({field: "passwordExpirationDate", type: "<=", value: 10});
            }

            // Filter by rotation needed
            if ($('#filterRotationNeeded').is(':checked')) {
                filters.push({field: "rotationNeeded", type: "=", value: "YES"});
            }

            // Filter by "Failed" expiration dates
            if ($('#filterFailed').is(':checked')) {
                filters.push({field: "passwordExpirationDate", type: "=", value: "Failed"});
            }

            // Apply filters to the table
            if (filters.length > 0) {
                table.setFilter(filters);
            } else {
                table.clearFilter(true); // Clear all filters
            }
        }

        // Reapply filters when any checkbox is changed
        $('#locationCheckboxList input, #filterCritical, #filterRotationNeeded, #filterFailed').change(function() {
            saveLocationCheckboxState();
            applyFilters();
        });

        // Export to CSV functionality
        $('#exportButton').click(function() {
            let filename = "Password_Expiration_Report";

            // Determine which filters are applied
            const isFailedChecked = $('#filterFailed').is(':checked');
            const isRotationNeededChecked = $('#filterRotationNeeded').is(':checked');
            const isCriticalChecked = $('#filterCritical').is(':checked');

            // Build the filename based on the filters
            if (isFailedChecked && !isRotationNeededChecked && !isCriticalChecked) {
                filename += " - Failed only";
            } else if (!isFailedChecked && isRotationNeededChecked && !isCriticalChecked) {
                filename += " - Rotation Needed";
            } else if (!isFailedChecked && !isRotationNeededChecked && isCriticalChecked) {
                filename += " - Critical Entries";
            } else if (isFailedChecked || isRotationNeededChecked || isCriticalChecked) {
                filename += " - Combination";
            }

            // Add the file extension
            filename += ".csv";

            // Download the file with the dynamic filename
            table.download("csv", filename);
        });

        // Restore toggle state from cookies
        if (getCookie('locationCheckboxListVisible') === 'true') {
            $('#locationCheckboxList').show();
        } else {
            $('#locationCheckboxList').hide();
        }

        // Restore location checkbox states and apply filters on page load
        restoreLocationCheckboxState();
        applyFilters();
    });
</script>

{% endblock %}